#!/bin/bash
{{- if not .remote }}

{{- if or (eq .chezmoi.osRelease.id "bluefin") (eq .chezmoi.osRelease.id "fedora") }}

set -euo pipefail

# Install niri, waybar, and related tools on Fedora/Bluefin
# Reference: https://github.com/YaLTeR/niri/wiki

# Check if niri is already installed
if command -v niri >/dev/null 2>&1; then
  echo "niri is already installed"
  exit 0
fi

echo "Installing niri, waybar, and related tools..."

# Get Fedora version
. /etc/os-release
FEDORA_VERSION="${VERSION_ID:-42}"

# Enable COPR repository for niri
echo "Adding niri COPR repository..."
sudo dnf copr enable -y yalter/niri

# Refresh metadata
echo "Refreshing package metadata..."
sudo rpm-ostree refresh-md --force

# Install niri, waybar, and supporting tools
# - niri: Wayland compositor
# - waybar: Status bar
# - pavucontrol: PulseAudio volume control GUI
# - NetworkManager-tui: Network management TUI
# - blueman: Bluetooth device manager
echo "Installing packages..."
sudo rpm-ostree install niri waybar pavucontrol NetworkManager-tui blueman || {
  # If installation fails due to package already requested, that's OK
  # It means a previous attempt is still pending
  if sudo rpm-ostree status | grep -q "niri"; then
    echo "niri is already pending installation"
    echo "⚠️  A reboot is required to apply changes"
    echo "Run: systemctl reboot"
    exit 0
  else
    # Real error, propagate it
    exit 1
  fi
}

echo "✓ Niri, waybar, and tools installed successfully"
echo "⚠️  A reboot is required to apply changes"
echo "Run: systemctl reboot"

{{- else }}
echo "Niri installation is only supported on Bluefin and Fedora"
exit 0

{{- end }}
{{- end }}

