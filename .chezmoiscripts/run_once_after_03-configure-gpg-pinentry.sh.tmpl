#!/bin/bash
{{- if not .isMacOS }}
exit 0
{{- end }}

set -euo pipefail

echo "ðŸ” Configuring GPG to use terminal-based pinentry..."

# Create GPG config directory if it doesn't exist
mkdir -p "$HOME/.gnupg"

# Configure GPG to use terminal-based pinentry
GPG_AGENT_CONF="$HOME/.gnupg/gpg-agent.conf"

# Check if pinentry is installed
if ! command -v pinentry >/dev/null 2>&1; then
  echo "âŒ Error: pinentry is not installed"
  exit 1
fi

# Get the path to pinentry
PINENTRY_PATH=$(which pinentry)

# Update or create gpg-agent.conf with pinentry-mac
if [ -f "$GPG_AGENT_CONF" ]; then
  # Remove existing pinentry-program line if it exists
  sed -i '' '/^pinentry-program/d' "$GPG_AGENT_CONF"
fi

# Add pinentry-mac configuration
echo "pinentry-program $PINENTRY_PATH" >> "$GPG_AGENT_CONF"

# Ensure proper permissions
chmod 600 "$GPG_AGENT_CONF"

# Reload gpg-agent to apply changes
gpg-connect-agent reloadagent /bye &>/dev/null || true

echo "âœ… GPG configured to use terminal-based pinentry"
echo "   Pinentry program: $PINENTRY_PATH"
