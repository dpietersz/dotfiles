#!/bin/bash
{{- if not .remote }}

set -euo pipefail

# Install Kanshi - Wayland display configuration daemon
# Kanshi automatically switches monitor profiles based on connected outputs
# Documentation: https://github.com/emersion/kanshi
# Supported on: Bluefin (rpm-ostree) and Fedora (dnf)

# Check if Kanshi is already installed
if command -v kanshi >/dev/null 2>&1; then
  echo "Kanshi is already installed"
  exit 0
fi

{{- if eq .chezmoi.osRelease.id "bluefin" }}

# Bluefin - use rpm-ostree (atomic distro)
echo "Installing Kanshi via rpm-ostree..."
echo "Refreshing package metadata..."
sudo rpm-ostree refresh-md

echo "Installing Kanshi..."
sudo rpm-ostree install kanshi || {
  # If installation fails due to package already requested, that's OK
  if sudo rpm-ostree status | grep -q "kanshi"; then
    echo "Kanshi is already pending installation"
    echo "⚠️  A reboot is required to apply changes"
    echo "Run: systemctl reboot"
    exit 0
  else
    # Real error, propagate it
    exit 1
  fi
}

echo "✓ Kanshi installed successfully"
echo "⚠️  A reboot is required to apply changes"
echo "Run: systemctl reboot"

{{- else if or (eq .chezmoi.osRelease.id "fedora") (eq .chezmoi.osRelease.idLike "fedora") }}

# Fedora - use dnf
echo "Installing Kanshi via dnf..."
sudo dnf install -y kanshi
echo "✓ Kanshi installed successfully"

{{- else }}

echo "Error: Kanshi installation is only supported on Bluefin and Fedora"
echo "Please install Kanshi manually: https://github.com/emersion/kanshi"
exit 1

{{- end }}
{{- end }}
