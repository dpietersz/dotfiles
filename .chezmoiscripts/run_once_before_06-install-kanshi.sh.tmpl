#!/bin/bash
{{- if not .remote }}

set -euo pipefail

# Install Kanshi - Wayland display configuration daemon
# Kanshi automatically switches monitor profiles based on connected outputs
# Documentation: https://github.com/emersion/kanshi

# Check if Kanshi is already installed
if command -v kanshi >/dev/null 2>&1; then
  echo "Kanshi is already installed"
  exit 0
fi

{{- if eq .chezmoi.os "darwin" }}

# macOS - use Homebrew
if command -v brew >/dev/null 2>&1; then
  echo "Installing Kanshi via Homebrew..."
  brew install kanshi
  echo "✓ Kanshi installed successfully"
else
  echo "Error: Homebrew not installed"
  exit 1
fi

{{- else if eq .chezmoi.osRelease.id "bluefin" }}

# Bluefin - use rpm-ostree (atomic distro)
echo "Installing Kanshi via rpm-ostree..."
echo "Refreshing package metadata..."
sudo rpm-ostree refresh-md

echo "Installing Kanshi..."
sudo rpm-ostree install kanshi || {
  # If installation fails due to package already requested, that's OK
  if sudo rpm-ostree status | grep -q "kanshi"; then
    echo "Kanshi is already pending installation"
    echo "⚠️  A reboot is required to apply changes"
    echo "Run: systemctl reboot"
    exit 0
  else
    # Real error, propagate it
    exit 1
  fi
}

echo "✓ Kanshi installed successfully"
echo "⚠️  A reboot is required to apply changes"
echo "Run: systemctl reboot"

{{- else if or (eq .chezmoi.osRelease.id "fedora") (eq .chezmoi.osRelease.idLike "fedora") }}

# Regular Fedora - use dnf
if command -v dnf >/dev/null 2>&1; then
  echo "Installing Kanshi via dnf..."
  sudo dnf install -y kanshi
  echo "✓ Kanshi installed successfully"
fi

{{- else if or (eq .chezmoi.osRelease.id "ubuntu") (eq .chezmoi.osRelease.id "debian") }}

# Ubuntu/Debian - use apt
if command -v apt >/dev/null 2>&1; then
  echo "Installing Kanshi via apt..."
  sudo apt update
  sudo apt install -y kanshi
  echo "✓ Kanshi installed successfully"
fi

{{- else if or (eq .chezmoi.osRelease.id "arch") (eq .chezmoi.osRelease.id "manjaro") }}

# Arch Linux / Manjaro - use pacman
echo "Installing Kanshi via pacman..."
sudo pacman -S --noconfirm kanshi
echo "✓ Kanshi installed successfully"

{{- else }}

echo "Error: Kanshi installation is not configured for this distribution"
echo "Please install Kanshi manually: https://github.com/emersion/kanshi"
exit 1

{{- end }}
{{- end }}
