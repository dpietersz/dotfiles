#!/bin/bash
{{- if not .remote }}

set -euo pipefail

# Install nushell
# Reference: https://www.nushell.sh/book/installation.html

# Check if nushell is already installed
if command -v nu >/dev/null 2>&1; then
  echo "nushell is already installed"
  exit 0
fi

{{- if eq .chezmoi.os "darwin" }}

# macOS - use Homebrew
if command -v brew >/dev/null 2>&1; then
  echo "Installing nushell via Homebrew..."
  brew install nushell
  echo "✓ Nushell installed successfully"
else
  echo "Error: Homebrew not installed"
  exit 1
fi

{{- else if or (eq (get .chezmoi.osRelease "id" "") "bluefin") (eq (get .chezmoi.osRelease "id" "") "fedora") }}

# Bluefin/Fedora - use Homebrew if available, otherwise use rpm-ostree
if command -v brew >/dev/null 2>&1; then
  echo "Installing nushell via Homebrew..."
  brew install nushell
  echo "✓ Nushell installed successfully"
else
  echo "Installing nushell via rpm-ostree..."

  # Enable COPR repository for nushell
  echo "Adding nushell COPR repository..."
  sudo dnf copr enable -y atim/nushell

  # Refresh metadata
  echo "Refreshing package metadata..."
  sudo rpm-ostree refresh-md --force

  # Install nushell
  echo "Installing nushell..."
  sudo rpm-ostree install nushell

  echo "✓ Nushell installed successfully"
  echo "⚠️  A reboot is required to apply changes"
  echo "Run: systemctl reboot"
fi

{{- else }}
echo "Nushell installation is not supported on this distribution"
exit 1

{{- end }}
{{- end }}

