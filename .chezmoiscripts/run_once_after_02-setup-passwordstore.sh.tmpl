#!/bin/bash
set -euo pipefail

{{ if not .remote -}}

echo "üîë Setting up password-store"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

# Check if passwordstore already exists
if [ -d "$HOME/.password-store/.git" ]; then
    echo "‚úÖ Password-store already cloned. Pulling latest changes..."
    cd "$HOME/.password-store"
    git pull
    exit 0
fi

# Install pass
echo "üì¶ Installing pass..."
{{- if eq .chezmoi.os "darwin" }}
if command -v brew >/dev/null; then
    brew install pass
else
    echo "‚ùå Homebrew not installed. Cannot install pass."
    exit 1
fi
{{- else if eq .chezmoi.osRelease.id "bluefin" }}
echo "Installing pass via rpm-ostree..."
sudo rpm-ostree install pass
echo "‚ö†Ô∏è  Reboot required to complete pass installation"
echo "   After reboot, re-run chezmoi apply to continue setup"
exit 0
{{- else if or (eq .chezmoi.osRelease.id "fedora") (eq .chezmoi.osRelease.idLike "fedora") }}
if command -v dnf >/dev/null; then
    sudo dnf install -y pass
fi
{{- else }}
echo "‚ùå No installation instructions for pass on your distribution."
exit 1
{{- end }}

echo "‚úÖ Pass installed"

# Clone passwordstore
echo "üì• Cloning password-store from GitLab..."
if ! git clone git@gitlab.com:pietersz-personal-tools/password-store.git "$HOME/.password-store"; then
    echo "‚ùå Failed to clone password-store. Check your SSH keys and GitLab access."
    exit 1
fi

echo "‚úÖ Password-store cloned successfully"

# Verify GPG key matches
EXPECTED_GPG_ID="207F38BA91AB8330DBF08766B4320995C8E1D17D"
REPO_GPG_ID=$(cat "$HOME/.password-store/.gpg-id" | tr -d '[:space:]')

if [ "$REPO_GPG_ID" != "$EXPECTED_GPG_ID" ]; then
    echo "‚ö†Ô∏è  Warning: .gpg-id in repo ($REPO_GPG_ID) doesn't match expected ($EXPECTED_GPG_ID)"
fi

echo ""
echo "‚úÖ Password-store setup complete!"
echo ""

{{ end -}}