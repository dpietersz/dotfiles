#!/bin/bash

set -euo pipefail

# ------------------ Enable playwright-mcp service ------------------
# This script enables the playwright-mcp service after chezmoi deployment.
# - On Linux (Bluefin/Fedora): Uses systemd + distrobox
# - On macOS: Uses launchd + native npx
# - On remote: Skips entirely

{{- if .remote }}
echo "[playwright-mcp-service] Skipping: remote environment (.remote=true)."
exit 0
{{- end }}

{{- if .isMacOS }}
# ------------------ macOS: Use launchd ------------------
echo "[playwright-mcp-service] macOS detected, using launchd..."

# Check if node/npx is available
if ! command -v npx >/dev/null 2>&1; then
  echo "[playwright-mcp-service] npx not found, skipping. Install Node.js first."
  exit 0
fi

# Install Playwright browsers if not already installed
if [ ! -d "$HOME/Library/Caches/ms-playwright" ]; then
  echo "[playwright-mcp-service] Installing Playwright browsers..."
  INSTALL_DIR=/tmp/playwright-install
  mkdir -p "$INSTALL_DIR"
  cd "$INSTALL_DIR"
  if [ ! -f package.json ]; then
    npm init -y >/dev/null 2>&1
    npm install @playwright/test >/dev/null 2>&1
  fi
  npx playwright install chromium
fi

# Create launchd plist for playwright-mcp
PLIST_FILE="$HOME/Library/LaunchAgents/com.playwright.mcp.plist"
mkdir -p "$HOME/Library/LaunchAgents"

cat > "$PLIST_FILE" << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.playwright.mcp</string>
    <key>ProgramArguments</key>
    <array>
        <string>/usr/local/bin/npx</string>
        <string>@playwright/mcp@latest</string>
        <string>--headless</string>
        <string>--port</string>
        <string>8931</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
    <key>StandardOutPath</key>
    <string>/tmp/playwright-mcp.log</string>
    <key>StandardErrorPath</key>
    <string>/tmp/playwright-mcp.err</string>
</dict>
</plist>
EOF

# Load the launchd service
launchctl unload "$PLIST_FILE" 2>/dev/null || true
launchctl load "$PLIST_FILE"

echo "[playwright-mcp-service] launchd service loaded."
sleep 3

# Verify the service is listening
if lsof -i :8931 >/dev/null 2>&1; then
  echo "[playwright-mcp-service] ✅ Playwright MCP is listening on http://localhost:8931/mcp"
else
  echo "[playwright-mcp-service] ⚠️  Warning: Service may not be listening. Check /tmp/playwright-mcp.log"
fi

exit 0
{{- end }}

# Only proceed if distrobox is installed
if ! command -v distrobox >/dev/null 2>&1; then
  echo "[playwright-mcp-service] distrobox not installed, skipping service enablement."
  exit 0
fi

# Check if playwright distrobox exists, create if not
DISTROBOX_CREATED=false
if ! distrobox list | grep -q "playwright"; then
  echo "[playwright-mcp-service] playwright distrobox not found, creating..."
  DISTROBOX_CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/distrobox"
  if [ -f "$DISTROBOX_CONFIG_DIR/playwright-toolbox.ini" ]; then
    distrobox-assemble create --file "$DISTROBOX_CONFIG_DIR/playwright-toolbox.ini"
    echo "[playwright-mcp-service] playwright distrobox created."
    DISTROBOX_CREATED=true
  else
    echo "[playwright-mcp-service] playwright-toolbox.ini not found, skipping."
    exit 0
  fi
fi

# Ensure Playwright browsers are installed and up-to-date
# The MCP server may need a newer browser version than what's in the image
echo "[playwright-mcp-service] Ensuring Playwright browsers are installed..."
distrobox enter playwright -- bash -c '
  export PLAYWRIGHT_BROWSERS_PATH=/opt/playwright-browsers
  
  # Fix permissions if needed (allow MCP to create browser profiles)
  sudo chmod -R 777 /opt/playwright-browsers 2>/dev/null || true
  
  # Install chromium using a temp project (npx playwright install needs a project context)
  INSTALL_DIR=/tmp/playwright-install
  if [ ! -f "$INSTALL_DIR/package.json" ]; then
    echo "Setting up Playwright install environment..."
    mkdir -p "$INSTALL_DIR"
    cd "$INSTALL_DIR"
    npm init -y >/dev/null 2>&1
    npm install @playwright/test >/dev/null 2>&1
  fi
  
  cd "$INSTALL_DIR"
  echo "Installing Chromium browser..."
  npx playwright install chromium || echo "Browser install completed (or already installed)"
'
echo "[playwright-mcp-service] Playwright browsers ready."

# Check if service file exists
SERVICE_FILE="$HOME/.config/systemd/user/playwright-mcp.service"
if [ ! -f "$SERVICE_FILE" ]; then
  echo "[playwright-mcp-service] Service file not found at $SERVICE_FILE"
  exit 0
fi

echo "[playwright-mcp-service] Enabling and starting playwright-mcp systemd service..."

# Reload systemd user daemon to pick up the new service file
systemctl --user daemon-reload

# Enable the service (creates the symlink in default.target.wants/)
systemctl --user enable playwright-mcp.service

# Stop any existing instance on port 8931 to avoid conflicts
if lsof -i :8931 >/dev/null 2>&1; then
  echo "[playwright-mcp-service] Stopping existing process on port 8931..."
  lsof -ti :8931 | xargs kill -9 2>/dev/null || true
  sleep 2
fi

# Start the service if not already running
if ! systemctl --user is-active --quiet playwright-mcp.service; then
  systemctl --user start playwright-mcp.service
  echo "[playwright-mcp-service] Service started."
  # Wait for service to be ready
  sleep 3
else
  echo "[playwright-mcp-service] Service already running."
fi

echo "[playwright-mcp-service] Done. Status:"
systemctl --user status playwright-mcp.service --no-pager || true

# Verify the service is listening on port 8931
if lsof -i :8931 >/dev/null 2>&1; then
  echo "[playwright-mcp-service] ✅ Playwright MCP is listening on http://localhost:8931/mcp"
else
  echo "[playwright-mcp-service] ⚠️  Warning: Service may not be listening on port 8931 yet. Check logs with: journalctl --user -u playwright-mcp.service -n 20"
fi
