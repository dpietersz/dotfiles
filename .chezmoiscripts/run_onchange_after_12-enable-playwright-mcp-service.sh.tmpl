#!/bin/bash

set -euo pipefail

# ------------------ Setup Playwright MCP ------------------
# This script sets up Playwright for use with OpenCode MCP.
#
# On Linux (Bluefin/Fedora):
#   1. Creates playwright distrobox from ghcr.io/dpietersz/playwright-toolbox
#   2. Exports playwright CLI tools to host via distrobox-export
#   3. Installs/updates browsers inside the container
#   4. Starts the MCP server via systemd
#
# On macOS:
#   1. Installs Playwright browsers natively
#   2. Starts the MCP server via launchd
#
# On remote: Skips entirely

{{- if .remote }}
echo "[playwright] Skipping: remote environment (.remote=true)."
exit 0
{{- end }}

{{- if .isMacOS }}
# ------------------ macOS: Native installation ------------------
echo "[playwright] macOS detected, using native installation..."

# Check if node/npx is available
if ! command -v npx >/dev/null 2>&1; then
  echo "[playwright] npx not found, skipping. Install Node.js first."
  exit 0
fi

# Install Playwright browsers if not already installed
if [ ! -d "$HOME/Library/Caches/ms-playwright" ]; then
  echo "[playwright] Installing Playwright browsers..."
  INSTALL_DIR=/tmp/playwright-install
  mkdir -p "$INSTALL_DIR"
  cd "$INSTALL_DIR"
  if [ ! -f package.json ]; then
    npm init -y >/dev/null 2>&1
    npm install @playwright/test >/dev/null 2>&1
  fi
  npx playwright install chromium
fi

# Detect actual npx path (mise installs to dynamic location)
NPX_PATH=$(command -v npx)
if [ -z "$NPX_PATH" ]; then
  echo "[playwright] npx not found, skipping."
  exit 0
fi
echo "[playwright] Using npx at: $NPX_PATH"

# Create launchd plist for playwright-mcp
PLIST_FILE="$HOME/Library/LaunchAgents/com.playwright.mcp.plist"
mkdir -p "$HOME/Library/LaunchAgents"

cat > "$PLIST_FILE" << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.playwright.mcp</string>
    <key>EnvironmentVariables</key>
    <dict>
        <key>PATH</key>
        <string>$HOME/.local/share/mise/shims:/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin</string>
    </dict>
    <key>ProgramArguments</key>
    <array>
        <string>$NPX_PATH</string>
        <string>@playwright/mcp@latest</string>
        <string>--headless</string>
        <string>--browser</string>
        <string>chromium</string>
        <string>--port</string>
        <string>8931</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
    <key>StandardOutPath</key>
    <string>/tmp/playwright-mcp.log</string>
    <key>StandardErrorPath</key>
    <string>/tmp/playwright-mcp.err</string>
</dict>
</plist>
EOF

# Load the launchd service
launchctl unload "$PLIST_FILE" 2>/dev/null || true
launchctl load "$PLIST_FILE"

echo "[playwright] launchd service loaded."
sleep 3

# Verify the service is listening
if lsof -i :8931 >/dev/null 2>&1; then
  echo "[playwright] ✅ Playwright MCP is listening on http://localhost:8931/mcp"
else
  echo "[playwright] ⚠️  Warning: Service may not be listening. Check /tmp/playwright-mcp.log"
fi

exit 0
{{- end }}

# ------------------ Linux: Distrobox-based installation ------------------

# Only proceed if distrobox is installed
if ! command -v distrobox >/dev/null 2>&1; then
  echo "[playwright] distrobox not installed, skipping."
  exit 0
fi

# Check if playwright distrobox exists, create if not
if ! distrobox list | grep -q "playwright"; then
  echo "[playwright] Creating playwright distrobox..."
  DISTROBOX_CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/distrobox"
  if [ -f "$DISTROBOX_CONFIG_DIR/playwright-toolbox.ini" ]; then
    distrobox-assemble create --file "$DISTROBOX_CONFIG_DIR/playwright-toolbox.ini"
    echo "[playwright] Distrobox created."
  else
    echo "[playwright] playwright-toolbox.ini not found, skipping."
    exit 0
  fi
fi

# Export Playwright CLI tools to host (this is the distrobox way!)
# This makes playwright, playwright-test, playwright-codegen available on the host
echo "[playwright] Exporting Playwright CLI tools to host..."
if [ ! -f "$HOME/.local/bin/playwright" ]; then
  distrobox enter playwright -- /usr/local/bin/setup-host-integration
  echo "[playwright] CLI tools exported to ~/.local/bin/"
else
  echo "[playwright] CLI tools already exported."
fi

# Ensure browsers are installed and up-to-date
echo "[playwright] Ensuring browsers are installed..."
distrobox enter playwright -- bash -c '
  export PLAYWRIGHT_BROWSERS_PATH=/opt/playwright-browsers
  
  # Fix permissions for browser profiles
  sudo chmod -R 777 /opt/playwright-browsers 2>/dev/null || true
  
  # Install chromium using a temp project context
  INSTALL_DIR=/tmp/playwright-install
  if [ ! -f "$INSTALL_DIR/package.json" ]; then
    mkdir -p "$INSTALL_DIR"
    cd "$INSTALL_DIR"
    npm init -y >/dev/null 2>&1
    npm install @playwright/test >/dev/null 2>&1
  fi
  cd "$INSTALL_DIR"
  npx playwright install chromium 2>&1 || true
'
echo "[playwright] Browsers ready."

# Start the MCP server via systemd
SERVICE_FILE="$HOME/.config/systemd/user/playwright-mcp.service"
if [ ! -f "$SERVICE_FILE" ]; then
  echo "[playwright] Service file not found at $SERVICE_FILE, skipping MCP setup."
  echo "[playwright] ✅ Playwright CLI tools are available on host. Use: playwright --help"
  exit 0
fi

echo "[playwright] Starting MCP server..."
systemctl --user daemon-reload
systemctl --user enable playwright-mcp.service

# Stop any existing instance on port 8931
if lsof -i :8931 >/dev/null 2>&1; then
  echo "[playwright] Stopping existing process on port 8931..."
  lsof -ti :8931 | xargs kill -9 2>/dev/null || true
  sleep 2
fi

# Start the service
if ! systemctl --user is-active --quiet playwright-mcp.service; then
  systemctl --user start playwright-mcp.service
  sleep 3
fi

# Verify
if lsof -i :8931 >/dev/null 2>&1; then
  echo "[playwright] ✅ MCP server listening on http://localhost:8931/mcp"
else
  echo "[playwright] ⚠️  MCP server may not be ready. Check: journalctl --user -u playwright-mcp -n 20"
fi

echo "[playwright] ✅ Setup complete!"
echo "[playwright]    - CLI tools: playwright, playwright-test, playwright-codegen"
echo "[playwright]    - MCP server: http://localhost:8931/mcp"
